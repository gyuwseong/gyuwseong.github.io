{"componentChunkName":"component---src-templates-post-jsx","path":"/localstack-testing/","result":{"data":{"site":{"siteMetadata":{"title":"gyuwseong"}},"markdownRemark":{"id":"54e07400-3ae1-5858-9c8e-4e98d0deb327","excerpt":"AWS 를 다룰 때, 특정 기능 구현에 필요한 리소스는 AWS 콘솔에서 쉽게 생성하여 테스트할 수 있다. 그러나 이번에 DynamoDB 를 처음 써보았기 때문에 ddb 를 사용하여 Lambda 를 트리거 하는 가장 간단한 방법인 stream 활성화를 로컬에서 테스트해 보고 싶었다. AWS 콘솔이 아닌 로컬에서 리소스 기능을 테스트하는 대표적인 방법에는 A…","html":"<p>AWS 를 다룰 때, 특정 기능 구현에 필요한 리소스는 AWS 콘솔에서 쉽게 생성하여 테스트할 수 있다. 그러나 이번에 DynamoDB 를 처음 써보았기 때문에 ddb 를 사용하여 Lambda 를 트리거 하는 가장 간단한 방법인 stream 활성화를 로컬에서 테스트해 보고 싶었다.</p>\n<p>AWS 콘솔이 아닌 로컬에서 리소스 기능을 테스트하는 대표적인 방법에는 AWS SAM 을 사용하는 것이 있다.\nAWS SAM(Serverless Application Model) 은 AWS CloudFormation 의 확장 기능으로, <code class=\"language-text\">template.yaml</code> 에 정의된 SAM 템플릿은 내부적으로 CloudFormation 템플릿으로 변환되어 AWS 리소스를 배포하게 된다. 다만 이번 작업에서 핵심적으로 확인하고 싶은 기능인 ddb stream 은 SAM local 에서 테스트가 불가능하기 때문에 localstack 을 사용하기로 했다.</p>\n<p> </p>\n<h2 id=\"Localstack\" style=\"position:relative;\"><a href=\"#Localstack\" aria-label=\"Localstack permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a><strong>Localstack</strong></h2>\n<p><a href=\"https://docs.localstack.cloud/user-guide/aws/dynamodbstreams/\">Localstack 공식 문서</a> 에 DynamoDB 생성 후 Lambda 와 연결까지 하는 과정이 잘 설명되어 있다.</p>\n<h3 id=\"DynamoDB-stream-활성화\" style=\"position:relative;\"><a href=\"#DynamoDB-stream-%ED%99%9C%EC%84%B1%ED%99%94\" aria-label=\"DynamoDB stream 활성화 permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a><strong>DynamoDB stream 활성화</strong></h3>\n<p>처음 작업을 시작할 때, 이미 내 로컬에는 도커로 띄워둔 로컬 ddb 가 있는 상태였다. 따라서 localstack 에 ddb 부터 띄우는 것이 아니라, lambda 만 추가로 생성하여 이벤트 소스 연결 후, 테스팅하는 방법을 시도했다.</p>\n<p> </p>\n<p>ddb 에 lambda 를 트리거 할 주체가 되는 테이블을 추가할 때, stream 을 활성화하는 옵션을 넣어야 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"StreamSpecification\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"StreamEnabled\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"StreamViewType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"NEW_AND_OLD_IMAGES\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">StreamSpecification</code> 은 ddb 테이블의 stream 기능을 활성화하는 속성이다.</li>\n<li><code class=\"language-text\">StreamEnabled</code> 을 true 로 설정하면 stream 기능이 활성화되고, 테이블의 데이터 변경 사항을 스트림으로 기록할 수 있게 된다.</li>\n<li><code class=\"language-text\">StreamViewType</code> 은 스트림으로 기록되는 데이터 변경 사항의 종류를 지정하는 속성이다. 내 경우는 데이터 추가, 수정, 삭제 시를 기록하기 위해 <code class=\"language-text\">NEW_AND_OLD_IMAGES</code> 로 지정했다.</li>\n</ul>\n<p> </p>\n<p>aws cli 명령어로 dynamoDB 테이블을 생성하면 테이블에 대한 정보를 볼 수 있는데, 이때 lambda 를 트리거 할 이벤트 소스를 얻을 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token string\">\"LatestStreamArn\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"arn:aws:dynamodb:ddblocal:000000000000:table/example-table/stream/2024-10-09T16:48:34.325\"</span></code></pre></div>\n<p> </p>\n<p> </p>\n<h3 id=\"Localstack-실행\" style=\"position:relative;\"><a href=\"#Localstack-%EC%8B%A4%ED%96%89\" aria-label=\"Localstack 실행 permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a><strong>Localstack 실행</strong></h3>\n<p>stream 활성화 옵션을 추가한 테이블이 생성되면, 해당 테이블이 트리거 할 lambda 를 localstack 환경에 생성하기 위해 localstack 을 docker 에 띄운다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">-it</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">SERVICES</span><span class=\"token operator\">=</span>lambda <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-p</span> <span class=\"token number\">4566</span>:4566 <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-p</span> <span class=\"token number\">4571</span>:4571 <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">--name</span> localstack localstack/localstack</code></pre></div>\n<p>위에서 언급했듯이 ddb 는 로컬에서 돌아가고 있었기에 Lambda 만 활성화하였다.</p>\n<p> </p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">awslocal lambda create-function <span class=\"token punctuation\">\\</span>\n  --function-name processDynamoDBStream <span class=\"token punctuation\">\\</span>\n  --zip-file fileb://index.zip <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">--handler</span> index.handler <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">--runtime</span> nodejs18.x <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">--role</span> arn:aws:iam::000000000000:role/lambda-role</code></pre></div>\n<p>실행 중인 localstack 에 lambda 함수를 processDynamoDBStream 라는 이름으로 생성해준다.</p>\n<p> </p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">awslocal lambda create-event-source-mapping <span class=\"token punctuation\">\\</span>\n  --function-name processDynamoDBStream <span class=\"token punctuation\">\\</span>\n  --event-source-arn arn:aws:dynamodb:ddblocal:000000000000:table/example-table/stream/2024-10-09T16:48:34.325 <span class=\"token punctuation\">\\</span>\n  --batch-size <span class=\"token number\">1</span> <span class=\"token punctuation\">\\</span>\n  --starting-position TRIM_HORIZON</code></pre></div>\n<p>해당 람다에 위의 stream arn 을 맵핑해준다.</p>\n<p> </p>\n<p> </p>\n<h2 id=\"Local-DynamoDB-region-이슈\" style=\"position:relative;\"><a href=\"#Local-DynamoDB-region-%EC%9D%B4%EC%8A%88\" aria-label=\"Local DynamoDB region 이슈 permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a><strong>Local DynamoDB region 이슈</strong></h2>\n<p>위의 과정을 거치면 아래의 에러 메세지를 확인할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">WARN --- <span class=\"token punctuation\">[</span>et.reactor-0<span class=\"token punctuation\">]</span> l.aws.handlers.region\n<span class=\"token builtin class-name\">:</span> Region <span class=\"token string\">'ddblocal'</span> is not available. Resetting the region to <span class=\"token string\">'us-east-1'</span><span class=\"token builtin class-name\">.</span>\nPlease consider using a region <span class=\"token keyword\">in</span> the <span class=\"token string\">'aws'</span> partition to avoid any unexpected behavior.\nAvailable regions: <span class=\"token punctuation\">[</span><span class=\"token string\">'af-south-1'</span>, <span class=\"token string\">'ap-east-1'</span>, <span class=\"token string\">'ap-northeast-1'</span>, <span class=\"token string\">'ap-northeast-2'</span>,\n<span class=\"token string\">'ap-northeast-3'</span>, <span class=\"token string\">'ap-south-1'</span>, <span class=\"token string\">'ap-south-2'</span>, <span class=\"token string\">'ap-southeast-1'</span>, <span class=\"token string\">'ap-southeast-2'</span>,\n<span class=\"token string\">'ap-southeast-3'</span>, <span class=\"token string\">'ap-southeast-4'</span>, <span class=\"token string\">'ap-southeast-5'</span>, <span class=\"token string\">'ca-central-1'</span>, <span class=\"token string\">'ca-west-1'</span>,\n<span class=\"token string\">'eu-central-1'</span>, <span class=\"token string\">'eu-central-2'</span>, <span class=\"token string\">'eu-north-1'</span>, <span class=\"token string\">'eu-south-1'</span>, <span class=\"token string\">'eu-south-2'</span>, <span class=\"token string\">'eu-west-1'</span>,\n<span class=\"token string\">'eu-west-2'</span>, <span class=\"token string\">'eu-west-3'</span>, <span class=\"token string\">'il-central-1'</span>, <span class=\"token string\">'me-central-1'</span>, <span class=\"token string\">'me-south-1'</span>,\n<span class=\"token string\">'sa-east-1'</span>, <span class=\"token string\">'us-east-1'</span>, <span class=\"token string\">'us-east-2'</span>, <span class=\"token string\">'us-west-1'</span>, <span class=\"token string\">'us-west-2'</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>localstack 은 aws 와 유사하게 동작하게 되므로, 람다와 연결하려는 arn region 이 aws 에 등록된 region 중 하나가 아니면 연결하지 못한다는 의미였다. region 변경을 시도했으나, <code class=\"language-text\">aws configure</code> 명령어를 통해 region 을 임의로 변경하더라도 도커로 ddb 를 띄우면 여전히 로컬에서의 region 은 고정되어 있었다. 따라서 localstack 으로 lambda 만 따로 생성하는 것이 아니라, ddb 부터 함께 생성하는 방식으로 방향을 변경했다.</p>\n<p> </p>\n<h3 id=\"DynamoDB-와-Lambda-생성\" style=\"position:relative;\"><a href=\"#DynamoDB-%EC%99%80-Lambda-%EC%83%9D%EC%84%B1\" aria-label=\"DynamoDB 와 Lambda 생성 permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a><strong>DynamoDB 와 Lambda 생성</strong></h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">-it</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">SERVICES</span><span class=\"token operator\">=</span>dynamodb,lambda <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-p</span> <span class=\"token number\">4566</span>:4566 <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-p</span> <span class=\"token number\">4571</span>:4571 <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">--name</span> localstack localstack/localstack</code></pre></div>\n<p>lambda 와 dynamodb 둘 다 Localstack 에서 실행한다.</p>\n<p> </p>\n<p>동일하게 stream 활성화 옵션이 있는 테이블을 ddb 에 추가하면</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token string\">\"LatestStreamArn\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"arn:aws:dynamodb:us-east-1:000000000000:table/example-table/stream/2024-10-10T07:03:04.273\"</span></code></pre></div>\n<p>위의 arn 을 얻을 수 있다. 처음과 다른 점은 ddblocal 이 아닌, localstack 기본 region 인 <code class=\"language-text\">us-east-1</code> 이 적용되어 있다는 점이다.</p>\n<p> </p>\n<p>ddb 에 테이블 추가 후, 위와 동일한 과정으로 lambda 함수 생성 후 arn 을 연결해 준다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/7507d4c7376e861862bc75b7d57a5dbc/0ea77/img2.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 4.117647058823529%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAQklEQVR42j3KORLAIAxD0dz/lsl48BLs1JhCwRR0b750uQeYFREfelkUorbs22YdYyQyJ3T12uqv9oKoHd8PobHgB+OTSvWx2e8hAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='img2' title='' src='/static/7507d4c7376e861862bc75b7d57a5dbc/ca1dc/img2.png' srcset='/static/7507d4c7376e861862bc75b7d57a5dbc/e7570/img2.png 170w,\n/static/7507d4c7376e861862bc75b7d57a5dbc/f46e7/img2.png 340w,\n/static/7507d4c7376e861862bc75b7d57a5dbc/ca1dc/img2.png 680w,\n/static/7507d4c7376e861862bc75b7d57a5dbc/0ea77/img2.png 682w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>성공적으로 이벤트 소스가 맵핑되었고,</p>\n<p> </p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 563px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/05638ca1823b0cae4ce72fee0a1bc81a/e80ce/img3.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 53.529411764705884%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABCElEQVR42qWS226CQBCGeZKWiq3AclAENCZVoyKo9YR6YaI2ff+HGGcG10oJF9SLL7OTTP7956CY7RQazSWoxgSJCryZ00oohrcBw1tD3Z7Du0MsctREXMqvUHwDBVu9I9jhDoS/xbjnt9NBugewwhSLInjVx8ikAHX1mLOgFaSgeyvQW5IlI/wNY7bXiIzynXVFo6KYsWLX7DDonyEcXNDZnp0STucALrokxxL6XEaChGQ9URMJOsQCmtVL409bnI9L2y1t2f88wYe74CQ/7PhOpaVo1oytqsb0X2dSOBsR7IBukYQ1K0HxJwX9/ilbyvAbuqMf3NzXU04VzZ6xOzpseudnU13wCvgAYAd8ogCzAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='img3' title='' src='/static/05638ca1823b0cae4ce72fee0a1bc81a/e80ce/img3.png' srcset='/static/05638ca1823b0cae4ce72fee0a1bc81a/e7570/img3.png 170w,\n/static/05638ca1823b0cae4ce72fee0a1bc81a/f46e7/img3.png 340w,\n/static/05638ca1823b0cae4ce72fee0a1bc81a/e80ce/img3.png 563w' sizes='(max-width: 563px) 100vw, 563px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>localstack gui 에서도 해당 정보를 확인할 수 있다.</p>\n<p> </p>\n<h2 id=\"Docker-network-이슈\" style=\"position:relative;\"><a href=\"#Docker-network-%EC%9D%B4%EC%8A%88\" aria-label=\"Docker network 이슈 permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a><strong>Docker network 이슈</strong></h2>\n<p>ddb 를 lambda 에 연결한 후, 정상적으로 lambda 가 invoke 되는지 확인하기 위해 테이블에 데이터를 저장했는데, 또 다른 이슈가 있었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">ERROR --- <span class=\"token punctuation\">[</span>et.reactor-2<span class=\"token punctuation\">]</span> l.services.lambda_.hints   <span class=\"token builtin class-name\">:</span>\nFailed to create the runtime executor <span class=\"token keyword\">for</span> the <span class=\"token keyword\">function</span> processDynamoDBStream.\nPlease ensure that Docker is available <span class=\"token keyword\">in</span> the LocalStack container by adding\nthe volume <span class=\"token function\">mount</span> <span class=\"token string\">\"/var/run/docker.sock:/var/run/docker.sock\"</span> to your LocalStack startup.\nCheck out https://docs.localstack.cloud/user-guide/aws/lambda/<span class=\"token comment\">#docker-not-available</span></code></pre></div>\n<p>에러 메세지에 있는 문서를 확인해 보니 현재 람다 함수가 local executor mode, 즉 로컬 실행 모드에서 실행 중인데, 이는 람다 함수가 도커를 사용하지 않고 localStack 컨테이너 내에서 직접 실행되는 모드를 의미하는 것이다. 따라서, localStack 을 실행할 때 Docker 소켓을 올바르게 마운트하도록 실행해 주면 문제를 해결할 수 있다.</p>\n<p> </p>\n<h3 id=\"Docker-소켓-마운트\" style=\"position:relative;\"><a href=\"#Docker-%EC%86%8C%EC%BC%93-%EB%A7%88%EC%9A%B4%ED%8A%B8\" aria-label=\"Docker 소켓 마운트 permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a><strong>Docker 소켓 마운트</strong></h3>\n<ul>\n<li>Docker 데몬: <a href=\"https://www.geeksforgeeks.org/what-is-docker-daemon/\">해당 링크</a>에서 자세한 설명을 볼 수 있다. Docker 컨테이너를 관리하고 실행하는 핵심 컴포넌트라고 이해하면 된다.</li>\n<li>Docker 소켓: Docker 데몬과의 통신을 위해 사용되는 Unix 소켓으로, 이 소켓을 통해 Docker 컨테이너는 호스트 시스템에서 실행 중인 Docker 데몬과 상호작용할 수 있다.</li>\n<li>마운트: Docker 컨테이너가 호스트 시스템의 파일이나 디렉터리에 접근할 수 있도록 연결하는 과정이다. 소켓 파일을 마운트하면, 컨테이너 내의 프로세스가 호스트의 Docker 데몬에 접근할 수 있다.</li>\n<li>LocalStack 은 AWS Lambda 와 같은 기능을 에뮬레이션 하는 데 Docker 를 사용하므로 LocalStack 이 Lambda 함수를 Docker 환경에서 실행하기 위해서는 Docker 소켓에 접근할 수 있어야 한다.</li>\n</ul>\n<p> </p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">-it</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">--network</span> sam <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">SERVICES</span><span class=\"token operator\">=</span>dynamodb,lambda <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-p</span> <span class=\"token number\">4566</span>:4566 <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-p</span> <span class=\"token number\">4571</span>:4571 <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-v</span> /var/run/docker.sock:/var/run/docker.sock <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">--name</span> localstack localstack/localstack</code></pre></div>\n<p><code class=\"language-text\">-v /var/run/docker.sock:/var/run/docker.sock</code> 옵션을 추가하여 localstack 을 실행한다. 이 옵션은 Docker 소켓 파일(/var/run/docker.sock)을 LocalStack 컨테이너 내의 동일한 경로에 연결한다. 이렇게 하면 LocalStack이 Docker를 사용하여 Lambda 함수를 실행할 수 있게 된다.</p>\n<p> </p>\n<p>옵션 변경 후 다시 람다를 invoke 하게 되면 정상적으로 테이블에 데이터가 저장되면서 람다가 invoke 됐음을 확인할 수 있다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/a3787d7390acbe6e9fb585913c2f2e9d/8471f/img6.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 7.647058823529412%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAbklEQVR42k2MbQqAIBBEu0xB2ZdpheEJJLPv+99k2pWIfgzDY3Zf0k0nhFogzYnWHGBW9iI+kEsfWds7Rpod9bihoXBX/QqhF5R9QKkDcUAilEfWuCjNO4+CmkfmtHYknb+nalhJ9pMS823sd38AZUBD15z1TBAAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='img6' title='' src='/static/a3787d7390acbe6e9fb585913c2f2e9d/ca1dc/img6.png' srcset='/static/a3787d7390acbe6e9fb585913c2f2e9d/e7570/img6.png 170w,\n/static/a3787d7390acbe6e9fb585913c2f2e9d/f46e7/img6.png 340w,\n/static/a3787d7390acbe6e9fb585913c2f2e9d/ca1dc/img6.png 680w,\n/static/a3787d7390acbe6e9fb585913c2f2e9d/02d09/img6.png 1020w,\n/static/a3787d7390acbe6e9fb585913c2f2e9d/9d567/img6.png 1360w,\n/static/a3787d7390acbe6e9fb585913c2f2e9d/8471f/img6.png 1818w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/9c2c511f52f154c6b74141538163574c/26003/img4.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 12.941176470588234%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAp0lEQVR42i2PSxKDIBBEvf+NkoWpyh2S+AFFFPEDSpSsOzMkiym6ut9MF5mQDYRs4fyGPbxhpxmjnWBGC08ea86bVsEYi34waThfFkfeiHX1sMTZeUF2uebIb3c8ngVko/AqKujeoBYN9j2gqOqky0r8RxJbouI8hHSYi3iXuUx1GoKEcx7bthMwYaYmBmP8oFU6FXS6T7rTw8+j94wRK+0xdxxn+uEX1JLblJYyNzwAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='img4' title='' src='/static/9c2c511f52f154c6b74141538163574c/ca1dc/img4.png' srcset='/static/9c2c511f52f154c6b74141538163574c/e7570/img4.png 170w,\n/static/9c2c511f52f154c6b74141538163574c/f46e7/img4.png 340w,\n/static/9c2c511f52f154c6b74141538163574c/ca1dc/img4.png 680w,\n/static/9c2c511f52f154c6b74141538163574c/26003/img4.png 842w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p><code class=\"language-text\">aws.putItem</code> 이 람다를 실행했고, 람다가 invoke 되어 로그가 찍혔음을 확인할 수 있다.</p>","frontmatter":{"title":"Localstack 으로 DynamoDB + Lambda testing 해보기","date":"October 06, 2024","update":"October 06, 2024","tags":["AWS","Infrastructure"],"series":null},"fields":{"slug":"/localstack-testing/","readingTime":{"minutes":8.885}}},"seriesList":{"edges":[{"node":{"id":"df9dfe4a-14ef-52df-8f36-06d199c90656","fields":{"slug":"/understanding-jvm/"},"frontmatter":{"title":"JVM 이해하기"}}},{"node":{"id":"913126a1-04ee-5720-a45b-83c532ccb8eb","fields":{"slug":"/quick-youtube-search/"},"frontmatter":{"title":"작고 귀여운 크롬 확장 프로그램 만들기"}}},{"node":{"id":"d078781e-ce36-55d1-af07-598e0b000d92","fields":{"slug":"/leetcode-3sum/"},"frontmatter":{"title":"leetcode 15. 3Sum"}}},{"node":{"id":"e551e659-5a38-5541-91a6-c8ff96915d0d","fields":{"slug":"/blog-migration/"},"frontmatter":{"title":"블로그 옮기기"}}},{"node":{"id":"356ea60d-b20c-5ad8-92ea-413c2fdb3a81","fields":{"slug":"/gatsby-version-ps/"},"frontmatter":{"title":"종속성 문제 해결하기"}}},{"node":{"id":"96b29891-a242-5bbf-9728-56799a9f3cc1","fields":{"slug":"/minimum-spanning-tree/"},"frontmatter":{"title":"최소비용 신장 트리 (Minimum Spanning Tree)"}}},{"node":{"id":"3bdccf81-ee85-54e6-a829-ec21f0fcba6e","fields":{"slug":"/custom-repository/"},"frontmatter":{"title":"Custom repository 적용하기 (feat. Sequelize, TypeORM)"}}},{"node":{"id":"4f6f3366-663a-50df-aae8-f021f6b50c10","fields":{"slug":"/asynchronous-programming/"},"frontmatter":{"title":"비동기 프로그래밍"}}},{"node":{"id":"1040970d-b85f-527c-8ffa-b8a426e61197","fields":{"slug":"/boj-1181/"},"frontmatter":{"title":"input() vs sys.stdin.readline()"}}},{"node":{"id":"f7881a3e-b687-5510-8bfd-450faae1b187","fields":{"slug":"/boj-18110/"},"frontmatter":{"title":"python round() 와 반올림"}}},{"node":{"id":"e515c0a9-2a33-552f-901e-bd8b61db7c74","fields":{"slug":"/spring-container/"},"frontmatter":{"title":"스프링 컨테이너와 빈"}}},{"node":{"id":"54e07400-3ae1-5858-9c8e-4e98d0deb327","fields":{"slug":"/localstack-testing/"},"frontmatter":{"title":"Localstack 으로 DynamoDB + Lambda testing 해보기"}}},{"node":{"id":"4c97f39d-ad6a-5f1b-8e31-93d6a9853a86","fields":{"slug":"/what-is-index/"},"frontmatter":{"title":"인덱스 (Index)"}}}]},"previous":{"fields":{"slug":"/spring-container/"},"frontmatter":{"title":"스프링 컨테이너와 빈"}},"next":{"fields":{"slug":"/what-is-index/"},"frontmatter":{"title":"인덱스 (Index)"}}},"pageContext":{"id":"54e07400-3ae1-5858-9c8e-4e98d0deb327","series":null,"previousPostId":"e515c0a9-2a33-552f-901e-bd8b61db7c74","nextPostId":"4c97f39d-ad6a-5f1b-8e31-93d6a9853a86"}},"staticQueryHashes":[],"slicesMap":{}}